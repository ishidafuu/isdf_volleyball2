# エピソード管理ワークフロー

## 0. 概要と目的

### 0.1 ワークフローの目的
このワークフローは以下の目的を達成するために設計されています：

1. 物語の整合性維持
   - 時系列の一貫性確保
   - キャラクターの成長過程の追跡
   - 学校/チームの発展の記録

2. データの関連性管理
   - キャラクター間の関係性の明確化
   - エピソード間の因果関係の把握
   - 影響関係の追跡可能性の確保

3. 分析基盤の確立
   - キャラクターの成長ポイントの記録
   - 学校/チームの特色の変遷の追跡
   - ストーリーラインの分析

### 0.2 システム要件
1. データの一貫性
   - キャラクター情報の統一的な管理
   - 時系列情報の正確な記録
   - 関連性情報の確実な維持

2. 拡張性
   - 新規エピソードの追加容易性
   - 関連情報の柔軟な拡張
   - 分析視点の追加可能性

3. 検索性
   - キャラクター視点での検索
   - 時系列での検索
   - テーマ/カテゴリでの検索

## 1. エピソード作成の基本フロー

### 1.1 前提確認
目的：新規エピソードの整合性確保と重複防止

1. 既存エピソードの確認
   - 目的：関連エピソードの把握と整合性チェック
   ```sql
   -- 関連エピソードの検索
   SELECT id, title, timeline, category 
   FROM episodes 
   WHERE timeline = '{timeline}' 
   OR category = '{category}';
   ```

2. 必要な参照情報の収集
   - 目的：登場キャラクターと関連情報の正確な紐付け
   ```sql
   -- キャラクター情報の確認
   SELECT * FROM characters 
   WHERE name = '{character_name}';
   ```

### 1.2 エピソードファイル作成
目的：一貫性のある形式でのエピソード保存と管理

1. 配置場所の決定
   - 目的：時系列とカテゴリに基づく整理された構造の維持
   ```
   episodes/
   ├── 3_years_ago/  # 3年前の出来事
   ├── 2_years_ago/  # 2年前の出来事
   ├── 1_year_ago/   # 1年前の出来事
   └── current/      # 現在の出来事
   ```

### 1.3 データベース登録
目的：検索可能な形でのエピソード情報の保存

1. episodesテーブルへの登録
   - 目的：エピソードの基本情報の記録
   ```sql
   INSERT INTO episodes (
     id, title, episode_type, content_path, 
     timeline, category, school_type, summary
   ) VALUES (...);
   ```

2. 関連テーブルの更新
   - 目的：キャラクターへの影響と関連性の記録
   ```sql
   -- キャラクターの役割と影響を記録
   INSERT INTO episode_characters (...) VALUES (...);
   ```

## 2. データ整合性の確認

### 2.1 キャラクター名の表記確認
目的：キャラクター情報の一貫性確保

1. 表記揺れチェック
   - 目的：キャラクター名の統一的な管理
   ```sql
   SELECT character_name, COUNT(*) as count
   FROM episode_characters 
   GROUP BY character_name
   HAVING count > 1;
   ```

[... 以下、各セクションごとに目的と具体的な実装を記述 ...]

## 3. エピソード間の関連付け

### 3.1 関連付けの種類と目的
1. 直接的な関連
   - 目的：エピソード間の明確な因果関係の記録
   - 同一イベントの異なる視点
   - 時系列上の前後関係
   - キャラクターの成長過程

2. 間接的な関連
   - 目的：背景情報や影響関係の追跡
   - 同一学校/チームの異なるエピソード
   - 共通テーマを持つエピソード
   - 参照・言及関係

### 3.2 関連付けの実装
目的：エピソード間の関係性を検索可能な形で管理

```sql
-- 同一イベントの異なる視点の関連付け
INSERT INTO episode_relations VALUES (
  'eps_mch_main_match',     -- 主となる試合エピソード
  'eps_chr_player_pov',     -- 選手視点のエピソード
  'parallel',               -- 同時期の異なる視点
  '同一試合の選手視点からの描写'
);
```

## 4. 検証とメンテナンス

### 4.1 定期的な検証
目的：データの品質維持と整合性確保

1. 整合性チェック
   ```sql
   -- summary未設定のエピソード確認
   SELECT id, title 
   FROM episodes 
   WHERE summary IS NULL;
   ```

2. 関連性の検証
   ```sql
   -- 孤立したエピソードの確認
   SELECT e.id, e.title
   FROM episodes e
   LEFT JOIN episode_relations r 
   ON e.id = r.source_episode_id
   WHERE r.source_episode_id IS NULL;
   ```

### 4.2 メンテナンス手順
目的：システムの持続的な運用と改善

1. データクリーンアップ
   - 未使用データの特定と整理
   - 重複データの統合
   - 過去データの整理

2. システム改善
   - 新しい要件への対応
   - 検索機能の強化
   - パフォーマンスの最適化

